id: io.github.kovzol.bibref
runtime: org.kde.Platform
runtime-version: '6.9'
base: io.qt.qtwebengine.BaseApp
base-version: '6.9'
sdk: org.kde.Sdk
command: bibref-qt
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --system-talk-name=org.freedesktop.UDisks2
modules:
  - name: sword
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DSWORD_BUILD_UTILS=No
      - -DSWORD_BUILD_EXAMPLES=No
    cleanup:
      - /bin/*
    sources:
      - type: archive
        url: https://www.crosswire.org/ftpmirror/pub/sword/source/v1.9/sword-1.9.0.tar.gz
        sha256: 42409cf3de2faf1108523e2c5ac0745d21f9ed2a5c78ed878ee9dcc303426b8a
        x-checker-data:
          type: anitya
          project-id: 230546
          url-template: https://www.crosswire.org/ftpmirror/pub/sword/source/v${version0}.${version1}/sword-$version.tar.gz

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=system,filesystem
      - ./b2 -j $FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.89.0/source/boost_1_89_0.tar.gz
        sha256: 9de758db755e8330a01d995b0a24d09798048400ac25c03fc5ea9be364b13c93
        x-checker-data:
          type: anitya
          project-id: 6845
          url-template: https://archives.boost.io/release/$version/source/boost_${version0}_${version1}_${version2}.tar.gz

  - name: graphviz
    cleanup:
      - /share/man
      - /share/graphviz
      - /share/doc/graphviz
      - /bin/*
    sources:
      - type: archive
        url: https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/13.1.2/graphviz-13.1.2.tar.gz
        sha256: 4050d308fad1cd835b4afe2192f3677de2583891ebf0661cb9c565f611e4901d
        x-checker-data:
          type: anitya
          project-id: 1249
          url-template: https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/$version/graphviz-$version.tar.gz

  - name: bibref-qt
    buildsystem: cmake-ninja
    subdir: qt
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_SHARED_LIBS=ON
      - -UPROJECT_SOURCE_DIR
      - -DPROJECT_SOURCE_DIR=/app/share/bibref-qt
      - -DWEBENGINE=ON
    # The cmake machinery will put the required databases in $XDG_DATA_HOME (if it is set).
    # By setting that value we put the database to /app/tmp/.sword temporarily
    # and later we copy it to /app/share/sword in the post-install step:
    build-options:
      env:
        XDG_DATA_HOME: /app/tmp
    sources:
      # - type: git
      # url: https://github.com/kovzol/bibref
      # tag: 2025-09-14 # does not yet exist
      - type: archive
        url: https://github.com/kovzol/bibref/archive/912fad04a3f3fe8d4588c036d00c3af750c6be4b.zip
        sha256: 7d5e2c737ba547c149e4257fd1ab34adeabd05d0ef035783f02b05311d8a048f
    post-install:
      - mv /app/tmp/.sword/* /app/share/sword

cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig

cleanup-commands:
  - /app/cleanup-BaseApp.sh
